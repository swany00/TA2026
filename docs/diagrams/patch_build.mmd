flowchart TD
  A[index_*.csv chunk read] --> B[group by path_bt/path_rf/path_sza/year]
  B --> C[load BT/RF/SZA arrays]
  C --> D[extract patch around pixel_x/pixel_y]
  D --> E[validity checks\nin-bound, finite, landcover class]
  E --> F[normalize\nBT/RF/SZA/DEM + TA z-score]
  F --> G[build time7 / loc / landcover_onehot / meta]
  G --> H[append to in-memory payload]
  H --> I{payload >= patch_chunk_rows?}
  I -- yes --> J[save split_chunk_XXXXX.pt]
  I -- no --> K[continue]
  J --> K
  K --> L[end-of-split flush final chunk]
